---
title: "Data Exploration Oonagh"
author: "Oonagh Pretorius"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(naniar)
library(devtools)
library(tidyverse)
library(here)
library(janitor)
library(ggmap)
library(ggplot2)
library(lubridate)
library(dplyr)
```

Loading data

```{r}
visibility <- read_csv("data/CA_visibility_data.csv")%>% clean_names()
```

###TASKS

#### **Data Cleaning**

```{r}
glimpse(visibility)
```

```{r}
head(visibility) # the data are tidy
```

Any NAs?

```{r}
naniar::miss_var_summary(visibility) #there are no missing values
summary(visibility) #this shows that some values are coded as -999 and we must recode them to NAs
```

Change -999 to NAs
```{r}
visibility_tidy <- visibility %>% 
  na_if("-999")
```

Check for NAs again
```{r}
naniar::miss_var_summary(visibility_tidy) #there are no missing values
summary(visibility_tidy)
```

Importantly, this shows us that there are no missing values for "site_code", "site_name", "date", "longitude", "latitude", "elevation", and "state". The values that do have NAs are all below 10%.

**Changing classes** Not sure if this is necessary
#```{r}
visibility_tidy %>% mutate_if(is.character, as.factor)
glimpse(visibility_tidy) #shows that all the characters were converted to factors.
#```

#### **Exploration**

```{r}
names(visibility_tidy)
```

##### 1. How many sites and where are they? Check "site_code" vs. "site_name"
*There are 23 distinct sites names which we will use for analysis*

```{r}
visibility_tidy %>%
  summarize(distinct_site_code = n_distinct(site_code), #interestingly, there is one more site_code (24) than site_name (23).
            distinct_site_name = n_distinct(site_name),
            distinct_state = n_distinct(state)) #this confirms there is only data for CA in the dataset
```
OR
```{r}
visibility_tidy %>%
  summarize(across(c(site_code, site_name, state), n_distinct))
```

```{r}
visibility_tidy %>%
    tabyl(site_code, site_name)
```

```{r}
visibility_tidy %>% 
  tabyl(site_code, site_name) %>% 
  adorn_percentages() %>%
  adorn_pct_formatting(digits = 2) #cannot find the extra site_code. As all site_name variables contain 100% of their site codes, I think we should use the site_name variable going forward.
```

##### 2. where are the sites located in CA?
####### Step 1: Create a Base Map
a) Find the range of latitude and longitude for our data:
```{r}
visibility_tidy %>% 
  select(latitude, longitude) %>% #note that the lat and long are in degrees decimal
  summary()
```

b) Set the bounding box range:
```{r}
lat <- c(33.46, 41.71)
long <- c(-124.1, -116.4)
bbox <- make_bbox(long, lat, f = 0.05)
```

Let's get a base map for our bounding box area. We will use the stamen maps because they are free. There are several different map types, including: `terrain-labels`, `terrain-lines`, `toner`, `toner-2011`, `toner-background`, `toner-hybrid`, `toner-lines`, `toner-lite`, and `watercolor.`
```{r}
map1 <- get_map(bbox, maptype = "terrain", source = "stamen")
ggmap(map1)
```

####### Step 2: Adding Points to Base Map
`ggmap` works well with `ggplot2`. To add our points we only need to specify the x and y location similar to how we made charts in previous labs. 

**I. Basic map with site locations**
```{r}
ggmap(map1) + 
  geom_point(data = visibility_tidy, aes(longitude, latitude), size=1.5) +
  labs(x= "Longitude", y= "Latitude", title="Air Quality Research Site Locations in CA")
#ggsave("plot.png", width = 5, height = 5)
```

**II.Basic map with site location and by elevation**
-must change colours to display better. Choose palette?
-fix labels
```{r}
ggmap(map1) + 
  geom_point(data = visibility_tidy, aes(longitude, latitude, colour=elevation), size=2.5) +
  labs(x= "Longitude", y= "Latitude", title="Air Quality Research Site Locations in CA")
```
**Saving maps**
```{r}
ggsave("plot.png", width = 5, height = 5) #Saves last plot as 5’ x 5’ file named "plot.png" in working directory.
#Matches file type to file extension.
```

Split date by year:
```{r}
visibility2 <- visibility_tidy %>% 
  separate(date, into= c("month", "day", "year"), sep = "/")
```


```{r}
visibility3 <- visibility2 %>% 
  group_by(site_name, year) %>% 
  summarise(across(c(svr_val, amm_no3f_val, amm_so4f_val, e_cf_val, om_cf_val, soi_lf_val, longitude, latitude), mean, na.rm=T), total=n())
```

**A) Graph Mean Standard Visual Range over time, faceted by site**
```{r}
visibility3 %>% 
  ggplot(aes(x=year, y=svr_val))+
  geom_point(na.rm=TRUE)+
  facet_wrap(~site_name, ncol=4)+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(title = "Standard Visual Range over Time",
       x = "Year",
       y = "Average Standard Visual Range (km)",) #fill by season?
```
**B)Graph Mean Ammonium Nitrate Concentration Over Time** faceted by site
```{r}
visibility3 %>% 
  ggplot(aes(x=year, y=amm_no3f_val))+
  geom_point(na.rm=TRUE)+
  facet_wrap(~site_name, ncol=4)+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(title = "Ammonium Nitrate Concentration over Time",
       x = "Year",
       y = "Ammonium Nitrate Concentration (ug/m^3)",) #fill by season?
```
**C) Graph Mean Ammonium Sulfate Concentration Over Time** faceted by site
```{r}
visibility3 %>% 
  ggplot(aes(x=year, y=amm_so4f_val))+
  geom_point(na.rm=TRUE)+
  facet_wrap(~site_name, ncol=4)+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(title = "Ammonium Sulfate Concentration over Time",
       x = "Year",
       y = "Ammonium Sulfate Concentration (ug/m^3)",) #fill by season?
```

**D) Graph Mean Elemental Carbon Concentration Over Time** faceted by site
```{r}
visibility3 %>% 
  ggplot(aes(x=year, y=e_cf_val))+
  geom_point(na.rm=TRUE)+
  facet_wrap(~site_name, ncol=4)+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(title = "Elemental Carbon Concentration over Time",
       x = "Year",
       y = "Elemental Carbon Concentration (ug/m^3)",) #fill by season?
```
####*Notes: Interesting fluctuations for Lassen, Lava Beds, Point Reyes, Yosemite, Sequoia, Trinity. Link to wildfire data?*



   "om_cf_val"     "om_cf_unit"    "soi_lf_val

Facet svr_val maps by year?


```{r}
visibility2 %>% 
  
ggmap(map1) + 
  geom_point(data = visibility2, aes(longitude, latitude), size=1.5) +
  labs(x= "Longitude", y= "Latitude", title="Air Quality Research Site Locations in CA")
#ggsave("plot.png", width = 5, height = 5)
```
```{r}
ggmap(map1) + 
  geom_point(data = visibility4, aes(longitude, latitude, colour=mean_svr), size=2.5) +
  labs(x= "Longitude", y= "Latitude", title="Air Quality Research Site Locations in CA") +
  facet_wrap(~year)
```


```{r}
ecosphere %>% 
  ggplot(aes(x=habitat, y=log10_mass, fill=habitat))+ 
  geom_boxplot(alpha=0.4)+ 
  facet_grid(.~habitat)+
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(title = "Mass by Mass and Habitat",
       x = NULL,
       y = "Log 10 Mass",
       fill = "Habitat")
```

```{r}
ecosphere %>% 
  ggplot(aes(x=diet, y=log10_mass, fill=migratory_strategy))+ 
  geom_boxplot(alpha=0.4) + 
  facet_wrap(~migratory_strategy, ncol=4)+ #ncol is how many column plots you want per line
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  labs(title = "Mass by Diet and Migratory Strategy",
       x = NULL,
       y = "Log 10 Mass",
       fill = "Migratory Strategy")
```



?plot visibility by elevation










```{r}
map2 <- visibility_tidy %>% 
  filter(date)
ggmap(map1, legend = "topleft")
map2 +
stat_density2d(
aes(x = longitude, y = latitude, fill = ..level.., alpha = ..level..),
size = 2, bins = 4, data = svr_val,
geom = "polygon"
)
overlay <- stat_density2d(
aes(x = lon, y = lat, fill = ..level.., alpha = ..level..),
bins = 4, geom = "polygon",
data = svr_val
)
```

```{r}
SiteMap <- ggmap("map1", legend = "topleft")
siteMap +
stat_density2d(
aes(x = longitude, y = latitude, fill = ..level.., alpha = ..level..),
size = 2, bins = 4, data = svr_val,
geom = "polygon"
)
overlay <- stat_density2d(
aes(x = lon, y = lat, fill = ..level.., alpha = ..level..),
bins = 4, geom = "polygon",
data = svr_val
)
```


```{r}
visibility_tidy$svr_val <- with(visibility_tidy, sqrt(delta_long^2 + delta_lat^2)); l <- ggplot(visibility_tidy, aes(long, lat))
```


```{r}


```

```{r}

l + geom_contour_filled(aes(fill = z))
x, y, alpha, color, fill, group, linetype, size, subgroup
```










##### 3. what is measured at these sites? Why?

#### **Potential questions**

1.  How does visibility change with elevation?
2.  How does visibility change over time (overall and by site)?
3.  Can changes in visibility be linked with major pollution events such as wild fires?
4.  What are the most/least polluted sites?
